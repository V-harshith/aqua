'use client';
import React, { useState, useEffect } from 'react';
import { useAuth } from '../hooks/useAuth';
import { useToast } from '../hooks/useToast';
import { dataService, PumpData } from '../services/dataService';
import Button from './ui/Button';
const Dashboard: React.FC = () => {
  const { user, signOut } = useAuth();
  const { success: showSuccess, error: showError } = useToast();
  const [pumps, setPumps] = useState<PumpData[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  // Load pumps on component mount
  useEffect(() => {
    loadPumps();
  }, []);
  const loadPumps = () => {
    try {
      const pumpData = dataService.getPumps();
      setPumps(pumpData);
    } catch (error) {
      showError({ title: '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ / Failed to load data' });
    } finally {
      setIsLoading(false);
    }
  };
  const getStatusColor = (status: string) => {
    switch (status) {
      case 'running': return 'bg-green-500';
      case 'stopped': return 'bg-red-500';
      case 'maintenance': return 'bg-yellow-500';
      default: return 'bg-gray-500';
    }
  };
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'running': return 'üü¢';
      case 'stopped': return 'üî¥';
      case 'maintenance': return 'üü°';
      default: return '‚ö´';
    }
  };
  const getStatusText = (status: string) => {
    switch (status) {
      case 'running': return '‡§ö‡§æ‡§≤‡•Ç / Running';
      case 'stopped': return '‡§¨‡§Ç‡§¶ / Stopped';
      case 'maintenance': return '‡§Æ‡§∞‡§Æ‡•ç‡§Æ‡§§ / Maintenance';
      default: return '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ / Unknown';
    }
  };
  const togglePump = async (pumpId: string) => {
    const pump = pumps.find(p => p.id === pumpId);
    if (!pump) return;
    const newStatus = pump.status === 'running' ? 'stopped' : 'running';
    const userEmail = user?.email || 'Unknown User';
    try {
      const updatedPump = dataService.updatePumpStatus(pumpId, newStatus, userEmail);
      if (updatedPump) {
        loadPumps(); // Reload all pumps to get fresh data
        showSuccess({ 
          title: `‡§™‡§Ç‡§™ ${newStatus === 'running' ? '‡§ö‡§æ‡§≤‡•Ç' : '‡§¨‡§Ç‡§¶'} ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ / Pump ${newStatus}` 
        });
      } else {
        showError({ title: '‡§™‡§Ç‡§™ ‡§Ö‡§™‡§°‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ / Pump update failed' });
      }
    } catch (error) {
      showError({ title: '‡§™‡§Ç‡§™ ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ / Pump control error' });
    }
  };
  const handleStartAll = async () => {
    try {
      const userEmail = user?.email || 'Unknown User';
      const updatedPumps = dataService.startAllPumps(userEmail);
      setPumps(updatedPumps);
      showSuccess({ title: '‡§∏‡§≠‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§™‡§Ç‡§™ ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§ø‡§è ‡§ó‡§è / All available pumps started' });
    } catch (error) {
      showError({ title: '‡§∏‡§≠‡•Ä ‡§™‡§Ç‡§™ ‡§ö‡§æ‡§≤‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•á / Failed to start all pumps' });
    }
  };
  const handleStopAll = async () => {
    try {
      const userEmail = user?.email || 'Unknown User';
      const updatedPumps = dataService.stopAllPumps(userEmail);
      setPumps(updatedPumps);
      showSuccess({ title: '‡§∏‡§≠‡•Ä ‡§™‡§Ç‡§™ ‡§¨‡§Ç‡§¶ ‡§ï‡§ø‡§è ‡§ó‡§è / All pumps stopped' });
    } catch (error) {
      showError({ title: '‡§∏‡§≠‡•Ä ‡§™‡§Ç‡§™ ‡§¨‡§Ç‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•á / Failed to stop all pumps' });
    }
  };
  const handleSignOut = async () => {
    try {
      await signOut();
      showSuccess({ title: '‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü / Successfully signed out' });
    } catch (error) {
      showError({ title: '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ / Sign out failed' });
    }
  };
  // Show loading screen
  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">üíß</div>
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600 text-lg">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... / Loading data...</p>
        </div>
      </div>
    );
  }
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      {/* Header */}
      <div className="bg-blue-600 text-white p-4 shadow-lg">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="text-3xl">üíß</div>
            <div>
              <h1 className="text-xl font-bold">‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§Ö‡§ï‡•ç‡§µ‡§æ</h1>
              <p className="text-blue-100 text-sm">Project Aqua</p>
            </div>
          </div>
          <button
            onClick={handleSignOut}
            className="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg font-medium transition-colors"
          >
            üö™ ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§≤‡•á‡§Ç / Exit
          </button>
        </div>
        {/* User Info */}
        <div className="mt-4 bg-blue-500/50 rounded-lg p-3">
          <p className="text-sm">
            ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ / Welcome: <span className="font-semibold">{user?.email || 'User'}</span>
          </p>
          <p className="text-xs text-blue-100 mt-1">
            ‡§Ü‡§ú ‡§ï‡§æ ‡§¶‡§ø‡§® / Today: {new Date().toLocaleDateString('hi-IN')}
          </p>
        </div>
      </div>
      {/* Quick Stats */}
      <div className="p-4">
        <div className="grid grid-cols-3 gap-3 mb-6">
          <div className="bg-green-500 text-white rounded-xl p-4 text-center shadow-lg">
            <div className="text-2xl font-bold">
              {pumps.filter(p => p.status === 'running').length}
            </div>
            <div className="text-sm">‡§ö‡§æ‡§≤‡•Ç / Running</div>
          </div>
          <div className="bg-red-500 text-white rounded-xl p-4 text-center shadow-lg">
            <div className="text-2xl font-bold">
              {pumps.filter(p => p.status === 'stopped').length}
            </div>
            <div className="text-sm">‡§¨‡§Ç‡§¶ / Stopped</div>
          </div>
          <div className="bg-yellow-500 text-white rounded-xl p-4 text-center shadow-lg">
            <div className="text-2xl font-bold">
              {pumps.filter(p => p.status === 'maintenance').length}
            </div>
            <div className="text-sm">‡§Æ‡§∞‡§Æ‡•ç‡§Æ‡§§ / Repair</div>
          </div>
        </div>
        {/* Total Runtime Display */}
        <div className="bg-white rounded-xl p-4 mb-6 shadow-lg border-l-4 border-blue-500">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="text-2xl">‚è±Ô∏è</div>
              <div>
                <h3 className="font-bold text-gray-800">‡§ï‡•Å‡§≤ ‡§∞‡§® ‡§ü‡§æ‡§á‡§Æ / Total Runtime</h3>
                <p className="text-sm text-gray-600">‡§∏‡§≠‡•Ä ‡§™‡§Ç‡§™ ‡§Æ‡§ø‡§≤‡§æ‡§ï‡§∞ / All pumps combined</p>
              </div>
            </div>
            <div className="text-right">
              <div className="text-2xl font-bold text-blue-600">
                {pumps.reduce((sum, p) => sum + p.totalRunTime, 0)} ‡§ò‡§Ç‡§ü‡•á
              </div>
              <div className="text-sm text-gray-500">hours</div>
            </div>
          </div>
        </div>
        {/* Pump List */}
        <div className="space-y-4">
          <h2 className="text-xl font-bold text-gray-800 mb-4">
            üö∞ ‡§™‡§Ç‡§™ ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø / Pump Status
          </h2>
          {pumps.map((pump) => (
            <div key={pump.id} className="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center space-x-3">
                  <div className="text-2xl">{getStatusIcon(pump.status)}</div>
                  <div>
                    <h3 className="font-bold text-gray-800">{pump.name}</h3>
                    <p className="text-sm text-gray-600">{pump.location}</p>
                    <p className="text-xs text-gray-500">
                      ‡§∞‡§® ‡§ü‡§æ‡§á‡§Æ / Runtime: {pump.totalRunTime} ‡§ò‡§Ç‡§ü‡•á / hours
                    </p>
                  </div>
                </div>
                <div className={`px-3 py-1 rounded-full text-white text-sm font-medium ${getStatusColor(pump.status)}`}>
                  {getStatusText(pump.status)}
                </div>
              </div>
              <div className="flex items-center justify-between">
                <div className="text-sm text-gray-500">
                  ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§ú‡§æ‡§Ç‡§ö / Last Check: {pump.lastChecked}
                </div>
                {pump.status !== 'maintenance' && (
                  <Button
                    onClick={() => togglePump(pump.id)}
                    className={`px-6 py-3 rounded-xl font-bold text-lg ${
                      pump.status === 'running' 
                        ? 'bg-red-500 hover:bg-red-600' 
                        : 'bg-green-500 hover:bg-green-600'
                    }`}
                  >
                    {pump.status === 'running' ? '‚èπÔ∏è ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç / Stop' : '‚ñ∂Ô∏è ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç / Start'}
                  </Button>
                )}
                {pump.status === 'maintenance' && (
                  <button
                    onClick={() => showError({ title: '‡§Æ‡§∞‡§Æ‡•ç‡§Æ‡§§ ‡§ö‡§≤ ‡§∞‡§π‡•Ä ‡§π‡•à / Under maintenance' })}
                    className="px-6 py-3 bg-yellow-500 text-white rounded-xl font-bold text-lg opacity-50 cursor-not-allowed"
                  >
                    üîß ‡§Æ‡§∞‡§Æ‡•ç‡§Æ‡§§ / Repair
                  </button>
                )}
              </div>
            </div>
          ))}
        </div>
        {/* Quick Actions */}
        <div className="mt-8 space-y-4">
          <h2 className="text-xl font-bold text-gray-800 mb-4">
            ‚ö° ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø / Quick Actions
          </h2>
          <div className="grid grid-cols-2 gap-4">
            <button
              onClick={handleStartAll}
              className="bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform hover:scale-105"
            >
              üü¢ ‡§∏‡§≠‡•Ä ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç<br/>
              <span className="text-sm font-normal">Start All</span>
            </button>
            <button
              onClick={handleStopAll}
              className="bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform hover:scale-105"
            >
              üî¥ ‡§∏‡§≠‡•Ä ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç<br/>
              <span className="text-sm font-normal">Stop All</span>
            </button>
            <button
              onClick={() => window.open('tel:+919876543210')}
              className="bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform hover:scale-105"
            >
              üìû ‡§Æ‡§¶‡§¶ ‡§ö‡§æ‡§π‡§ø‡§è<br/>
              <span className="text-sm font-normal">Need Help</span>
            </button>
            <button
              onClick={() => window.location.href = '/logs'}
              className="bg-purple-500 hover:bg-purple-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform hover:scale-105"
            >
              üìã ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø ‡§≤‡•â‡§ó<br/>
              <span className="text-sm font-normal">Activity Log</span>
            </button>
          </div>
        </div>
        {/* Emergency Alert */}
        <div className="mt-8 bg-red-100 border-l-4 border-red-500 p-4 rounded-lg">
          <div className="flex items-center">
            <div className="text-2xl mr-3">üö®</div>
            <div>
              <h3 className="font-bold text-red-800">‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤ / Emergency</h3>
              <p className="text-red-700 text-sm mt-1">
                ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç: +91-9876543210<br/>
                For any problem, call immediately: +91-9876543210
              </p>
            </div>
          </div>
        </div>
        {/* Data Export Option */}
        <div className="mt-6">
          <button
            onClick={() => {
              const data = dataService.exportData();
              const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `aqua-data-${new Date().toISOString().split('T')[0]}.json`;
              a.click();
              showSuccess({ title: '‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ / Data exported successfully' });
            }}
            className="w-full py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-medium transition-colors"
          >
            üíæ ‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç / Export Data
          </button>
        </div>
      </div>
    </div>
  );
};
export default Dashboard; 